!function(v){if(v){var p=v.helpers,m=v.defaults.global;m.elements.trapezium={backgroundColor:m.defaultColor,borderWidth:0,borderColor:m.defaultColor,borderSkipped:"bottom",type:"isosceles"},v.elements.Trapezium=v.elements.Rectangle.extend({getCorners:function(){var t=this._view,r=m.elements.trapezium,e=[],o=t.type||r.type,i=t.y,a=t.borderWidth||r.borderWidth,l=this.getUpperWidth()/2,n=this.getBottomWidth()/2,s=a/2;if(s=s<0?0:s,"isosceles"==o){var h=t.x;e=[[h-n+s,t.base],[h-l+s,i+s],[h+l-s,i+s],[h+n-s,t.base]]}else if("scalene"==o){var d=t.x1,u=t.x2;e=[[u-n+s,t.base],[d-l+s,i+s],[d+l-s,i+s],[u+n-s,t.base]]}return e},draw:function(){var t=this._chart.ctx,r=this._view,e=m.elements.trapezium,o=this.getCorners();this._cornersCache=o,t.beginPath(),t.fillStyle=r.backgroundColor||e.backgroundColor,t.strokeStyle=r.borderColor||e.borderColor,t.lineWidth=r.borderWidth||e.borderWidth;var a=["bottom","left","top","right"].indexOf(r.borderSkipped||e.borderSkipped,0);function l(s){return o[(a+s)%4]}-1===a&&(a=0),t.moveTo.apply(t,l(0));for(var n=1;n<4;n++)t.lineTo.apply(t,l(n));r.useShadow?(t.shadowColor="#999",t.shadowBlur=10):(t.shadowColor=null,t.shadowBlur=null),t.fill(),r.borderWidth&&t.stroke()},height:function(){var t=this._view;return t?t.base-t.y:0},inRange:function(t,r){return!!this._view&&function(t,r){for(var e=t[0],o=t[1],i=!1,a=0,l=r.length-1;a<r.length;l=a++){var n=r[a][0],s=r[a][1],d=r[l][1];s>o!=d>o&&e<(r[l][0]-n)*(o-s)/(d-s)+n&&(i=!i)}return i}([t,r],this._cornersCache?this._cornersCache:this.getCorners())},getBottomWidth:function(){var t=this._view;return t.bottomWidth+(t.additionalWidth||0)},getUpperWidth:function(){var t=this._view;return t.upperWidth+(t.additionalWidth||0)},inLabelRange:function(t){var e=this._view;if(!e)return!1;var o=this.getBottomWidth(),i=this.getUpperWidth();if("scalene"==e.type)return e.x1>e.x2?t>=e.x2-o/2&&t<=e.x1+i/2:t<=e.x2+o/2&&t>=e.x1-i/2;var a=Math.max(i,o);return t>=e.x-a/2&&t<=e.x+a/2},tooltipPosition:function(){var t=this._view;return{x:t.x||t.x2,y:t.base-(t.base-t.y)/2}},getArea:function(){for(var t=0,r=this._cornersCache?this._cornersCache:this.getCorners(),e=0,o=r.length;e<o;e++)t+=r[e][0]*r[e==r.length-1?0:e+1][1]*.5,t-=r[e==r.length-1?0:e+1][0]*r[e][1]*.5;return Math.abs(t)},getCenterPoint:function(){var o,i,a,l,n,t=this._cornersCache?this._cornersCache:this.getCorners(),r=0,e=0;for(o=0,i=t.length-1;o<t.length;i=o,o++)r+=((l=t[o])[0]+(n=t[i])[0])*(a=l[0]*n[1]-n[0]*l[1]),e+=(l[1]+n[1])*a;return{x:r/(a=6*this.getArea()),y:e/a}}}),v.defaults.tsfunnel={hover:{mode:"label"},gap:0,upperWidth:.8,bottomWidth:.45,keep:"auto",elements:{minHeight:18,borderWidth:0},tooltips:{callbacks:{title:function(){return""},label:function(t,r){return r.labels[t.index]+": "+r.datasets[t.datasetIndex].data[t.index]}}},labelConfig:{font:"12px Open Sans",lineHeight:18,offset:{top:4,bottom:0,left:0,right:0}},scales:{yAxes:[{type:"category",display:!1}],xAxes:[{type:"category",display:!1}]}},v.controllers.tsfunnel=v.DatasetController.extend({dataElementType:v.elements.Trapezium,initialize:function(t,r){if(v.controllers.bar.prototype.initialize.call(this,t,r),typeof t.options<"u"&&typeof t.options.sort<"u"&&"data"!==t.options.sort.substr(0,4)){var e=t.data.datasets[r],o=[];p.each(e.data,function(d,u){o.push({index:u,value:d})});for(var i=Object.keys(e),a=0,l=i.length;a<l;a++){var n=i[a],s=e[n];if(e.hasOwnProperty(n)&&Array.isArray(s)){var h=s.map(function(d,u){return s[o[u].index]});e[n]=h}}}},getAvailableHeight:function(){return this.chart.chartArea.bottom-this.chart.chartArea.top},getAvailableWidth:function(){return this.chart.chartArea.right-this.chart.chartArea.left},getMinHeight:function(t){for(var r=this.getAvailableHeight(),e=this.chart.options.elements.minHeight;t.length*e>r&&0!==e;)e--;return e},getTotalSum:function(t){for(var r=0,e=0,o=t.length;e<o;e++)r+=t[e];return r},reCalculateValuesForMinValue:function(t,r){for(var e=this.getTotalSum(t),o=e*r/this.getAvailableHeight(),i=0,a=0,l=[],n=0,s=t.length;n<s;n++){var h=t[n];h<=o&&(a+=o,i+=h,l[n]=o)}var d=(e-a)/(e-i);d=Math.ceil(d*Math.pow(10,10))/Math.pow(10,10);for(var u=!1,f=0,b=t.length;f<b;f++)if(void 0===l[f]){var c=t[f]*d;c<o&&(u=!0),l[f]=c}return u?this.reCalculateValuesForMinValue(l,r):l},calculateDrawOptions:function(t){var r=this.getMinHeight(t),e=this.chart.chartArea,o=this.getAvailableWidth(),i=this.getAvailableHeight(),n=o*this.chart.options.upperWidth,s=Math.atan(2*i/(n-o*this.chart.options.bottomWidth)),h=[];0!==r&&(t=this.reCalculateValuesForMinValue(t,r));for(var d=this.getTotalSum(t),u=(e.left+e.right)/2,f=i/d,b=0,c=n,x=0,w=t.length;x<w;x++){var W=e.top+b,g=t[x]*f;g<r&&(g=r);var C=e.top+(b+=g),A=c-2*g/Math.tan(s);h.push({upperWidth:c,bottomWidth:A,x:u,y:W,base:C}),c=A}return h},update:function(r){var e=this.chart,i=this.getMeta().data,a=this.getDataset(),l=[],n=this.calculateDrawOptions(a.data);p.each(a.data,function(s,h){var d="function"==typeof a.backgroundColor?a.backgroundColor():a.backgroundColor,u=p.getValueAtIndexOrDefault(d,h);l.push({orgIndex:h,value:s,backgroundColor:u,borderColor:p.getValueAtIndexOrDefault(a.borderColor,h,u),label:p.getValueAtIndexOrDefault(e.data.labels,h,a.label),drawOptions:n[h]})}),this.elementsData=l,p.each(i,function(s,h){this.updateElement(s,h,r)},this)},updateElement:function(r,e,o){var i=this.elementsData[e],a=i.drawOptions;p.extend(r,{_datasetIndex:this.index,_index:i.orgIndex,_model:{type:"isosceles",y:a.y,base:a.base,x:a.x,x1:0,x2:0,upperWidth:o?0:a.upperWidth,bottomWidth:o?0:a.bottomWidth,borderWidth:0,backgroundColor:i&&i.backgroundColor,borderColor:i&&i.borderColor}}),r.pivot()},updateDataBeforeDraw:function(){for(var t=this.chart.config.selectedItemIndex,r=this.getMeta(),e=0,o=r.data.length;e<o;e++){var i=r.data[e]._model;t===e?(i.additionalWidth=5,i.useShadow=!0):(i.additionalWidth=0,i.useShadow=!1)}},draw:function(t){this.updateDataBeforeDraw(),v.DatasetController.prototype.draw.call(this,t),this.drawLabels()},drawLabels:function(){var t=this.chart.ctx;t.textAlign="center",t.textBaseline="top",t.font=this.chart.options.labelConfig.font,t.fillStyle="white",p.each(this.elementsData,function(r){this.drawLabel(r)},this)},drawLabel:function(t){var r=this.chart.ctx,e=t.drawOptions,o=Array.isArray(t.label)?t.label:[t.label],i=this.chart.options.labelConfig,a=i.lineHeight,l=e.base-e.y,n=Math.floor(l/a),s=e.bottomWidth,h=[];o.forEach(function(W){if(r.measureText(W).width>s){var C=this.splitLabelText(W,s,n);h=h.concat(C)}else h.push(W)},this);for(var f=(l-(h=h.slice(0,n||1)).length*a)/2+(i.offset&&i.offset.top||0),b=e.x,c=0,x=h.length;c<x;c++)r.fillText(h[c],b,e.y+f+c*a)},splitLabelText:function(t,r,e){for(var o=[""],i=t.length,a=0,l=0;l<i;l++){var n=t.charAt(l);if(this.chart.ctx.measureText(o[a]+n).width>r){if(++a==e)break;o[a]=n}else o[a]+=n}return o},removeHoverStyle:function(t){v.DatasetController.prototype.removeHoverStyle.call(this,t,this.chart.options.elements.trapezium)}})}}(Chart);