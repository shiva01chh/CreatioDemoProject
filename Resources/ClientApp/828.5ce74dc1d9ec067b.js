"use strict";(self.webpackChunkapp_studio_enterprise_system_designer=self.webpackChunkapp_studio_enterprise_system_designer||[]).push([[828],{40828:(te,F,o)=>{o.r(F),o.d(F,{ClientUnitDesignerStructureService:()=>h,ClientUnitSchemaDesignerModule:()=>D});var P=o(88692),E=o(15756),z=o(56707),I=o(26522),p=o(17315),J=o(55953),O=o(79641),c=o(80542),r=o(28262),w=o(7976),G=o(11465),V=o(22063),u=o(36619),H=o(13528),b=o(27969),Y=o(11770),B=o(75378),A=o(98168),S=o(26903),N=o(74970);class k extends r.$W{constructor(e){super(e),this._dialogService=e.get(I.xA)}get _getDirection(){return[{value:p.Tk.Subscribe,title:this.getTranslation("SubscribeCaption")},{value:p.Tk.Publish,title:this.getTranslation("PublishCaption")}]}get _getMode(){return[{value:p.uV.Broadcast,title:this.getTranslation("BroadcastCaption")},{value:p.uV.PointToPoint,title:this.getTranslation("AddressCaption")}]}get translationPrefix(){return"SchemaDesigners.ClientUnitSchemaDesigner.ClientUnitMessagesMiniPage"}_getMiniCardConfig(e,t,n){const s=this._getDynamicFormConfig(e,t,n),a={title:this.getTranslation("Title"),cancelBtnTitle:this.getTranslation("Cancel"),dynamicForm:c.jlq.create(s),useValidation:!0};return this.getIsApplyButtonVisible()&&(a.okBtnTitle=this.getApplyButtonTitle()),a}_getDynamicFormConfig(e,t,n){return[{columns:[{formComponents:[new c.kSE({controlType:c.$5M.TextBox,key:"name",label:this.getTranslation("NameCaption"),value:e.name,required:!0,isDisabled:this.getIsControlsDisabled()||!n,validators:[a=>this.validateName(a,t,e.uId)]}),new c.kSE({controlType:c.$5M.DropDown,key:"direction",label:this.getTranslation("DirectionCaption"),value:e.direction,options:this._getDirection.map(a=>({key:a.value,value:a.title})),isDisabled:this.getIsControlsDisabled()||!n}),new c.kSE({controlType:c.$5M.DropDown,key:"mode",label:this.getTranslation("ModeCaption"),value:e.mode,options:this._getMode.map(a=>({key:a.value,value:a.title})),isDisabled:this.getIsControlsDisabled()||!n})]}]}]}openMiniCard(e,t,n){const s=this._getMiniCardConfig(e,t,n);return this._dialogService.open(c.Eqq,{data:s})}getIsControlsDisabled(){return!1}getApplyButtonTitle(){return this.getTranslation("Apply")}getIsApplyButtonVisible(){return!0}openMessageMiniCard(e,t,n=!0){return this.openMiniCard(e,t,n).pipe((0,N.h)(s=>s!==void 0),(0,b.U)(s=>(s.applyChangesInModel(e),e)),(0,S.B)())}}var i=o(64537);class C extends k{constructor(e){super(e)}static _createNewMessage(e){const t=new p.v0;return t.uId=(0,B.generateGuid)(),t.name="",t.direction=0,t.mode=0,t.parentSchemaUId=e,t}getApplyButtonTitle(){return this.getTranslation("Add")}execute(e){const t=C._createNewMessage(e.schema.uId),n=this.getMetaItemsGroup(e);return this.openMessageMiniCard(t,n).pipe((0,A.b)(s=>n.addItem(s)),(0,S.B)())}}C.\u0275fac=function(e){return new(e||C)(i.LFG(i.zs3))},C.\u0275prov=i.Yz7({token:C,factory:C.\u0275fac});class v extends k{constructor(e){super(e)}execute(e){const t=this.getMetaItemsGroup(e),n=t.findItem(e.itemUId),s=e.schema.getIsOwnMetaItem(n);return this.openMessageMiniCard(n,t,s)}}v.\u0275fac=function(e){return new(e||v)(i.LFG(i.zs3))},v.\u0275prov=i.Yz7({token:v,factory:v.\u0275fac});class y extends k{constructor(e){super(e)}getIsControlsDisabled(){return!0}getIsApplyButtonVisible(){return!1}execute(e){const t=this.getMetaItemsGroup(e),n=t.findItem(e.itemUId),s=e.schema.getIsOwnMetaItem(n);return this.openMessageMiniCard(n,t,s)}}y.\u0275fac=function(e){return new(e||y)(i.LFG(i.zs3))},y.\u0275prov=i.Yz7({token:y,factory:y.\u0275fac});var U=o(65149);class R extends r.$W{constructor(e){super(e),this._dialogService=e.get(I.xA)}get translationPrefix(){return"SchemaDesigners.ClientUnitSchemaDesigner.ClientUnitImagesMiniPage"}_getMiniCardConfig(e){const t={title:this.getTranslation("Title"),cancelBtnTitle:this.getTranslation("Cancel"),dynamicForm:c.jlq.create(e),useValidation:!0};return this.getIsApplyButtonVisible()&&(t.okBtnTitle=this.getApplyButtonTitle()),t}_getDynamicFormConfig(e,t,n){return[{columns:[{formComponents:[new c.kSE({controlType:c.$5M.TextBox,key:"name",label:this.getTranslation("NameTitle"),value:e.name,required:!0,isDisabled:this.getIsControlsDisabled()||!n,validators:[a=>this.validateName(a,t,e.uId)]}),new c.kSE({controlType:c.$5M.LocalizableText,key:"caption",label:this.getTranslation("CaptionTitle"),value:new u.CjD(e.caption),isDisabled:this.getIsControlsDisabled()}),new c.kSE({controlType:c.$5M.ImageUploader,key:"data",label:this.getTranslation("ImageTitle"),value:Object.assign(e.data,{}),isDisabled:this.getIsControlsDisabled()}),new c.kSE({controlType:c.$5M.TextBox,key:"Uid",label:this.getTranslation("UidTitle"),value:e.uId,isDisabled:!0})]}]}]}openMiniCard(e){return this._dialogService.open(c.Eqq,{data:e})}getIsControlsDisabled(){return!1}getApplyButtonTitle(){return this.getTranslation("Add")}getIsApplyButtonVisible(){return!0}openImageMiniCard(e,t,n=!0){const s=this._getDynamicFormConfig(e,t,n),a=this._getMiniCardConfig(s);return this.openMiniCard(a).pipe((0,N.h)(d=>d),(0,b.U)(d=>new U.Fp(d.getFormValues())),(0,S.B)())}}class M extends R{constructor(e){super(e)}getApplyButtonTitle(){return this.getTranslation("Add")}execute(e){const t=new U.Fp({uId:(0,B.generateGuid)(),caption:new u.CjD,parentSchemaUId:e.schema.uId}),n=this.getMetaItemsGroup(e);return this.openImageMiniCard(t,n).pipe((0,A.b)(s=>{const a=new U.Fp(s);a.updateFile(s.data),n.addItem(a)}),(0,S.B)())}}M.\u0275fac=function(e){return new(e||M)(i.LFG(i.zs3))},M.\u0275prov=i.Yz7({token:M,factory:M.\u0275fac});class _ extends R{constructor(e){super(e)}getApplyButtonTitle(){return this.getTranslation("Apply")}execute(e){const t=this.getMetaItemsGroup(e),n=t.findItem(e.itemUId),s=e.schema.getIsOwnMetaItem(n);return this.openImageMiniCard(n,t,s).pipe((0,S.B)(),(0,A.b)(a=>{n.name=a.name,n.caption=a.caption,n.updateFile(a.data)}))}}_.\u0275fac=function(e){return new(e||_)(i.LFG(i.zs3))},_.\u0275prov=i.Yz7({token:_,factory:_.\u0275fac});class T extends R{constructor(e){super(e)}getIsControlsDisabled(){return!0}getIsApplyButtonVisible(){return!1}execute(e){const t=this.getMetaItemsGroup(e),n=t.findItem(e.itemUId),s=e.schema.getIsOwnMetaItem(n);return this.openImageMiniCard(n,t,s)}}T.\u0275fac=function(e){return new(e||T)(i.LFG(i.zs3))},T.\u0275prov=i.Yz7({token:T,factory:T.\u0275fac});class h extends r.p4{get translationPrefix(){return"SchemaDesigners.ClientUnitSchemaDesigner.ClientUnitSchemaDesignerPage"}static _getImageActionsConfig(){const e=new r.H0;return e.editCommandType=_,e.deleteCommandType=r.G8,e.showCommandType=T,e}_getMessageItemsActions(e){const t=new r.H0;return t.editCommandType=v,t.deleteCommandType=r.G8,t.showCommandType=y,this.getChildrenActions(e,t)}_getMessagesStructureElement(e){const t=r.lw.create({caption:this.getTranslation("MessagesCaption"),icon:"client-unit-messages-icon.svg",uId:e.messages.uId,actions:this.getActions(this.getIsReadOnly(e),C),newChildActions:this._getMessageItemsActions(this.getIsReadOnly(e))});return t.addChildren(e.messages),t}_getImagesSchemaStructureElement(e){const t=h._getImageActionsConfig(),n=r.lw.create({caption:this.getTranslation("ImagesCaption"),icon:"client-unit-images-icon.svg",uId:e.images.uId,actions:this.getActions(this.getIsReadOnly(e),M),newChildActions:this.getChildrenActions(this.getIsReadOnly(e),t)});return e.images.forEach(s=>{const a=r.lw.create({caption:s.name,uId:s.uId,parentUId:n.uId,actions:this.getChildrenActions(this.getIsReadOnly(e),t,e.getIsOwnMetaItem(s))});n.addChild(a)}),n}_getJsCodeItem(e,t){return r.lw.create({caption:this.getTranslation("JsCaption"),icon:"schema-designer-code-icon.svg",canSelected:t,selected:t,uId:e+"_JS"})}_getLessCodeItem(e){return r.lw.create({caption:this.getTranslation("LessCaption"),icon:"schema-designer-code-icon.svg",canSelected:!0,uId:e+"_LESS"})}_resetActionsToView(e){!e||e.forEach(t=>{t.actions=[r.E_.createShowAction(r.J9)],this._resetActionsToView(t.children)})}_getParameters(e){const t=e.parameters.filter(s=>s.parentSchemaUId!==e.uId),n=this.getParametersSchemaStructureElement(e);return t.forEach(s=>{const a=n.children.find(d=>d.uId===s.uId);a&&(a.actions=[r.E_.createShowAction(r.J9)],this._resetActionsToView(a.children))}),n}getSchemaVisibleAddons(e){return this.featureService.getFeatureState("BRules-ClientUnitSchemaAddonShown").pipe((0,b.U)(t=>{var n;return(n=e.addons)===null||n===void 0?void 0:n.filter(s=>s.addonName===u.nM_.BusinessRule?t&&e.schemaType===u.Rbd.AngularSchema:s.addonName!==u.nM_.AppearanceSettings)}))}getModelStructureData(e){const t=[],n=e.isModule||e.schemaType===u.Rbd.AngularSchema;return t.push(this._getJsCodeItem(e.uId,n)),t.push(this.getLocalizableStringSchemaStructureElement(e)),t.push(this._getImagesSchemaStructureElement(e)),e.schemaType===u.Rbd.Module&&(t.splice(1,0,this._getLessCodeItem(e.uId)),t.splice(3,0,this._getMessagesStructureElement(e))),t.push(this._getParameters(e)),t}}h.\u0275fac=function(){let l;return function(t){return(l||(l=i.n5z(h)))(t||h)}}(),h.\u0275prov=i.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"});var Z=o(44799),$=o(15748),j=o(65304),Q=o(40508);function W(l,e){if(l&1){const t=i.EpF();i.TgZ(0,"ts-code-editor",10),i.NdJ("textChange",function(s){i.CHM(t);const a=i.oxw();return i.KtG(a.currentCode=s)})("textChange",function(s){i.CHM(t);const a=i.oxw();return i.KtG(a.onCodeChanged(s))}),i.qZA()}if(l&2){const t=i.oxw();i.Q6J("text",t.currentCode)("language",t.codeLanguage)("readOnly",t.isReadOnlyMode)}}function K(l,e){if(l&1){const t=i.EpF();i.TgZ(0,"crt-business-rule-edit",11),i.NdJ("businessRuleChanged",function(s){i.CHM(t);const a=i.oxw();return i.KtG(a.onBusinessRuleChanged(s))}),i.qZA()}if(l&2){const t=i.oxw();i.Q6J("businessRule",t.businessRuleDesign)("isReadOnlyMode",t.isReadOnlyMode)("schemaInfo",t.schemaInfo)}}class m extends r.qj{constructor(e){super(e),this._isParentUpdate=!1,this.showSourceCode=!0,this._featureService=e.get(G.UZ)}get apiDataService(){return this._apiDataService}get designerStructureService(){return this._designerStructureService}get modelType(){return p.f9}get workspaceItemType(){return J.yG.ClientUnitSchema}get canShowBusinessRules(){return this.showBusinessRules}static _clearSchemaInParameter(e){e.schema=""}_initActionHandlerMap(){this._setJSClickHandler(),this._setLessClickHandler()}_setJSClickHandler(){const e=this.model.uId+"_JS";this.setStructureClickHandler(e,r.AH.show,this._showJSCode.bind(this))}_showJSCode(){this.currentCode=this.model.body,this.codeLanguage=c.YpL.Javascript,this.showBusinessRules=!1,this.showSourceCode=!0,this.onCodeChanged=this._setJsCode}_setJsCode(e){this.model.body=e,this.setIsChanged()}_setLessClickHandler(){const e=this.model.uId+"_LESS";this.setStructureClickHandler(e,r.AH.show,this._showLessCode.bind(this))}_showLessCode(){this.currentCode=this.model.less,this.codeLanguage=c.YpL.Less,this.showBusinessRules=!1,this.showSourceCode=!0,this.onCodeChanged=this._setLessCode}_setLessCode(e){this.model.less=e,this.setIsChanged()}_subscribeOnMetaItemChanged(){this._onMetaItemChange=this.model.onMetaItemsChanged.pipe((0,H.R)(this.destroyed$)).subscribe(()=>{this.setIsChanged(),this.updateSchemaStructure()})}canInitAddonActionHandlers(e){return e===u.nM_.BusinessRule?this._featureService.getFeatureState("BRules-ClientUnitSchemaAddonShown").pipe((0,b.U)(t=>t&&this.model.schemaType===u.Rbd.AngularSchema)):super.canInitAddonActionHandlers(e)}openBusinessRuleAction(e,t,n,s){super.openBusinessRuleAction(e,t,n,s),this.showSourceCode=!1;const a=this.businessRulesAddonMetadata.rules.find(d=>d.uId===this.currentBusinessRuleUId);this.businessRuleDesign=new V.H3(a,(0,u.tWQ)(e.resources,a,this.userCulture),this.model.name,this.model.caption,V.tH.Page)}removeBusinessRuleAction(e,t,n){super.removeBusinessRuleAction(e,t,n),this.showSourceCode=!1}onItemEditComplete(e,t){super.onItemEditComplete(e,t);const n=this.model.findParameterByUId(e.uId);n&&(t.item.icon=(0,u.Qud)(n.type),m._clearSchemaInParameter(n))}onAddedItem(e,t){super.onAddedItem(e,t),t.forEach(n=>{const s=this.model.findParameterByUId(n.uId);s&&m._clearSchemaInParameter(s)})}getGtmSchemaName(){return"ClientUnitSchemaDesignerPage"}injectDependencies(){super.injectDependencies(),this._designerStructureService=this.injector.get(h),this._apiDataService=this.injector.get(p.yc)}onModelSet(e){this._onMetaItemChange&&!this._onMetaItemChange.closed&&this._onMetaItemChange.unsubscribe(),super.onModelSet(e),this.currentCode=this.model.body,this.codeLanguage=c.YpL.Javascript,this.onCodeChanged=this._setJsCode,this._initActionHandlerMap(),this._subscribeOnMetaItemChanged()}getNeedEditDescription(){return!this._isParentUpdate&&super.getNeedEditDescription()}getRequestDataFromParameters(e){return{packageUId:e.packageId,extendParent:/^true$/i.test(e.extendParent),schemaType:+e.schemaType}}createTempDesignItem(e){const t=super.createTempDesignItem(e);return t.schemaType=+e.schemaType,t.less="",t.extendParent=/^true$/i.test(e.extendParent),t}getOpenDesignerEditModeUrl(){const e=this.getUseFullHierarchy(),t=this.model,n=[t.uId,t.package.uId,e.toString()],s=G.zz.getInterfaceDesignerOpenTemplate();return Y.Ld.format(s,...n)}ngOnInit(){super.ngOnInit(),this.enableOpenMetaDataMenuItem()}}m.\u0275fac=function(e){return new(e||m)(i.Y36(i.zs3))},m.\u0275cmp=i.Xpm({type:m,selectors:[["ts-client-unit-schema-designer-page"]],features:[i.qOj],decls:10,vars:8,consts:[[1,"base-section-wrap"],[3,"saveButtonVisible","actionMenuItemsConfig","saveClick","cancelClick","closeClick"],[1,"schema-designer-page"],[1,"schema-designer-structure-wrapper","pane"],[3,"dataSource","caption","isSearchEnabled","designerTypeCaptionImage","itemActionClick","itemClick"],[1,"schema-designer-page-main-content"],[1,"pane"],[1,"schema-designer-page-code-editor-wrapper"],[3,"text","language","readOnly","textChange",4,"ngIf"],[3,"businessRule","isReadOnlyMode","schemaInfo","businessRuleChanged",4,"ngIf"],[3,"text","language","readOnly","textChange"],[3,"businessRule","isReadOnlyMode","schemaInfo","businessRuleChanged"]],template:function(e,t){e&1&&(i.TgZ(0,"div",0)(1,"ts-schema-designer-page-header",1),i.NdJ("saveClick",function(){return t.save()})("cancelClick",function(){return t.cancel()})("closeClick",function(){return t.close()}),i.qZA(),i.TgZ(2,"div",2)(3,"div",3)(4,"ts-schema-designer-structure",4),i.NdJ("itemActionClick",function(s){return t.onStructureItemClick(s)})("itemClick",function(s){return t.onStructureItemClick(s)}),i.qZA()(),i.TgZ(5,"div",5)(6,"div",6)(7,"div",7),i.YNc(8,W,1,3,"ts-code-editor",8),i.YNc(9,K,1,3,"crt-business-rule-edit",9),i.qZA()()()()()),e&2&&(i.xp6(1),i.Q6J("saveButtonVisible",t.saveButtonVisible())("actionMenuItemsConfig",t.getActionsConfig()),i.xp6(3),i.Q6J("dataSource",t.schemaStructure)("caption",t.model.name)("isSearchEnabled",t.isSearchEnabled)("designerTypeCaptionImage","client-unit-description-icon.svg"),i.xp6(4),i.Q6J("ngIf",t.showSourceCode),i.xp6(1),i.Q6J("ngIf",t.canShowBusinessRules))},dependencies:[Z.z,P.O5,$.h,j.a,Q.w],encapsulation:2});const X=[{path:"",component:m},{path:"new",component:m},{path:":uId",component:m}];class f{}f.\u0275fac=function(e){return new(e||f)},f.\u0275mod=i.oAB({type:f}),f.\u0275inj=i.cJS({imports:[w.Bz.forChild(X),w.Bz]}),function(){(typeof ngJitMode>"u"||ngJitMode)&&i.kYT(f,{imports:[w.Bz],exports:[w.Bz]})}();var L=o(84945),x=o(61528),q=o(61541);class g extends r.vM{constructor(e){super(e),this._apiDataService=e.get(p.yc),this._maskService=e.get(I.Bm)}get translationPrefix(){return"SchemaDesigners.ClientUnitSchemaDesigner.ClientUnitDesignerMiniPage"}get editDescriptionCaptionKey(){return"Title"}static _createLocalizableString(e=""){const t=new u.CjD;return t.setValueLocalizableString("en-US",e),t}static _getNeedChangeParent(e,t){const n=e?.name||"",s=t?.name||"";return n!==s}_getCurrentParentOption(e){if(!e)return null;const t=e.caption.getValue(this.translateService.currentLang);return{key:e.uId,value:t}}_getParentFormConfig(e){const t=g.availableParents.map(s=>({key:s.uId,value:`${s.title} (${s.name})`})),n=e.extendParent;return new c.kSE({controlType:c.$5M.Autocomlete,key:"parent",label:this.getTranslation("ParentCaption"),value:this._getCurrentParentOption(e.parent),required:n,validators:e.extendParent?[s=>r.Pu.validateRequiredName(s,this.getTranslation("Validations.RequiredNameCaption"))]:null,changeValue:e.extendParent?this.setNameCaptionFromParent:null,isDisabled:this.getIsReadOnly(e),options:t})}_loadAvailableParents(e){const t=e.schemaType===u.Rbd.None;return this._apiDataService.getAvailableParents(e.package.uId,t,e.schemaType).pipe((0,b.U)(n=>n.success?n.items:[]),(0,S.B)())}_disabledControls(e,t){t.forEach(n=>{const s=e.find(a=>a.key===n);s&&(s.isDisabled=!0)})}_changeModelParent(e,t){return this._maskService.showBodyMask(),this._apiDataService.applyParent({schema:e,newParentUid:t.uId}).pipe((0,A.b)(()=>this._maskService.hideBodyMask()),(0,x.w)(n=>this._processApplyParentResponse(n,e)))}_processApplyParentResponse(e,t){var n;return e.success?(t.updateMetaItems(e.schema),(0,L.of)(!0)):this._dialogService.openInfoDialog((n=e?.errorInfo)===null||n===void 0?void 0:n.message).pipe((0,q.c)((0,L.of)(!1)))}setNameCaptionFromParent(e,t){const n=t.formGroup.controls.name,s=t.formGroup.controls.caption,a=g.availableParents.find(d=>d.uId===e.option.value.key);if(a&&a.name){const d=g._createLocalizableString(a.title);s.setValue(d),s.enable(),n.setValue(a.name)}}getMiniCardControls(e){const t=super.getMiniCardControls(e),n=e.model;if(!n.isModule){const s=t.findIndex(a=>a.key==="package.name");t.splice(s,0,this._getParentFormConfig(n))}return n.extendParent&&(this._disabledControls(t,["name"]),this.pageMode===r.t2.edit&&this._disabledControls(t,["parent"]),this.pageMode===r.t2.new&&!n.parent&&this._disabledControls(t,["caption"])),t}addValues(e,t){const n=super.addValues(e,t),s=new u.CjD;let a;if(e.parent){const d=g.availableParents.find(ee=>ee.uId===e.parent.key);s.setValueLocalizableString(this.translateService.currentLang,d.title),a={name:d.name,uId:d.uId,caption:s}}else!e.parent&&t.extendParent?a=t.parent:a={name:"",uId:B.EMPTY_GUID,caption:s};return n.parent=a,n}changeDescription(e,t){return g._getNeedChangeParent(e.parent,t.parent)?this._changeModelParent(e,t.parent).pipe((0,x.w)(()=>super.changeDescription(e,t))):super.changeDescription(e,t)}execute(e){const t=e.model;return(0,L.of)(t.isModule).pipe((0,x.w)(n=>n?super.execute(e):(this._maskService.showBodyMask(),this._loadAvailableParents(t).pipe((0,x.w)(s=>(g.availableParents=s,this._maskService.hideBodyMask(),super.execute(e))),(0,S.B)()))))}}g.\u0275fac=function(e){return new(e||g)(i.LFG(i.zs3))},g.\u0275prov=i.Yz7({token:g,factory:g.\u0275fac});class D{}D.\u0275fac=function(e){return new(e||D)},D.\u0275mod=i.oAB({type:D}),D.\u0275inj=i.cJS({providers:[c.Pnv,I.xA,r.ZR,C,v,y,r.kb,r.HL,r.J9,J.W1,r.G8,r.mM,r.Wr,{provide:c.thQ,useValue:"ClientUnitSchemaDesignerModule"},h,M,_,T,{provide:r.ZS,useClass:g}],imports:[O.wt,P.ez,c.kLW,E.yu,r.Z_,c.Y05,f,z.aw,I._M,I.Su,p.zU]}),function(){(typeof ngJitMode>"u"||ngJitMode)&&i.kYT(D,{declarations:[m],imports:[O.wt,P.ez,c.kLW,E.yu,r.Z_,c.Y05,f,z.aw,I._M,I.Su,p.zU]})}()}}]);
